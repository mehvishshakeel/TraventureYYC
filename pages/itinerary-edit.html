<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Edit Itinerary - TraventureYYC</title>
  <link rel="stylesheet" href="../css/main.css">
  <style>
    .conflict-warning {
      background-color: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: var(--radius-sm);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-md);
      display: none;
    }
    .conflict-warning.show {
      display: block;
    }
    .conflict-warning__title {
      font-weight: 700;
      color: #856404;
      margin-bottom: var(--spacing-xs);
    }
    .conflict-warning__list {
      margin-top: var(--spacing-sm);
      padding-left: var(--spacing-md);
    }
    .conflict-warning__item {
      color: #856404;
      margin-bottom: var(--spacing-xs);
    }
    .time-input-group {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }
    .time-input-group input {
      flex: 1;
    }
    /* Custom 24-hour time input */
    .custom-time-input {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 2px;
      background-color: var(--color-primary-light);
      border: 2px solid var(--color-primary-light);
      border-radius: var(--radius-sm);
      padding: 0;
      overflow: hidden;
    }
    .custom-time-input:focus-within {
      border-color: var(--color-primary);
      background-color: var(--color-background);
    }
    .time-input-hour,
    .time-input-min {
      flex: 1;
      border: none;
      background: transparent;
      padding: var(--spacing-md);
      font-size: 16px;
      text-align: center;
      color: var(--color-text-dark);
      outline: none;
      -moz-appearance: textfield;
      appearance: textfield;
    }
    .time-input-hour::-webkit-inner-spin-button,
    .time-input-hour::-webkit-outer-spin-button,
    .time-input-min::-webkit-inner-spin-button,
    .time-input-min::-webkit-outer-spin-button {
      -webkit-appearance: none;
      appearance: none;
      margin: 0;
    }
    .time-input-hour[type="number"],
    .time-input-min[type="number"] {
      -moz-appearance: textfield;
      appearance: textfield;
    }
    .time-separator {
      font-size: 18px;
      font-weight: 600;
      color: var(--color-text-dark);
      padding: 0 2px;
    }
    .location-input-wrapper {
      position: relative;
    }
    .location-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background-color: white;
      border: 2px solid var(--color-primary-light);
      border-top: none;
      border-radius: 0 0 var(--radius-sm) var(--radius-sm);
      max-height: 150px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .location-dropdown.show {
      display: block;
    }
    .location-dropdown-item {
      padding: var(--spacing-md);
      cursor: pointer;
      border-bottom: 1px solid var(--color-primary-light);
      transition: background-color 0.2s;
    }
    .location-dropdown-item:last-child {
      border-bottom: none;
    }
    .location-dropdown-item:hover,
    .location-dropdown-item:active {
      background-color: var(--color-primary-light);
    }
    .location-dropdown-item__text {
      font-size: 14px;
      color: var(--color-text-dark);
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Status Bar -->
    <div class="status-bar">
      <div class="status-bar__left">
        <div class="status-bar__time">9:41</div>
      </div>
      <div class="status-bar__right">
        <div class="status-bar__signal">
          <img src="../images/mobile-signal-60.svg" alt="Signal">
        </div>
        <div class="status-bar__wifi">
          <img src="../images/wifi-59.svg" alt="WiFi">
        </div>
        <div class="status-bar__battery">
          <img src="../images/combined-shape-57.svg" alt="Battery">
          <img src="../images/rectangle-58.svg" alt="Battery">
        </div>
      </div>
    </div>

    <!-- Top Bar -->
    <div class="top-bar">
      <a href="itinerary.html" style="color: var(--color-text-black);">←</a>
      <div class="top-bar__logo">
        Traventure<span class="top-bar__logo-accent">YYC</span>
      </div>
      <div class="top-bar__actions">
        <!-- Save button removed - using bottom form button instead -->
      </div>
    </div>

    <!-- Content -->
    <div class="content">
      <div id="conflictWarning" class="conflict-warning">
        <div class="conflict-warning__title">⚠️ Time Conflict Detected!</div>
        <div>This time slot conflicts with the following events:</div>
        <ul id="conflictList" class="conflict-warning__list"></ul>
      </div>

      <form id="editForm">
        <div class="form-group">
          <label class="form-label" for="title">Title</label>
          <input type="text" id="title" class="form-input" required>
        </div>

        <div class="form-group">
          <label class="form-label" for="date">Date</label>
          <input type="date" id="date" class="form-input" required>
        </div>

        <div class="form-group">
          <label class="form-label" for="time">Time</label>
          <div class="time-input-group">
            <!-- Start Time - 24-hour format -->
            <div class="custom-time-input">
              <input type="number" id="timeStartHour" class="form-input time-input-hour" min="0" max="23" placeholder="10" required>
              <span class="time-separator">:</span>
              <input type="number" id="timeStartMin" class="form-input time-input-min" min="0" max="59" placeholder="00" required>
              <input type="hidden" id="timeStart" required>
            </div>
            <span>-</span>
            <!-- End Time - 24-hour format -->
            <div class="custom-time-input">
              <input type="number" id="timeEndHour" class="form-input time-input-hour" min="0" max="23" placeholder="13" required>
              <span class="time-separator">:</span>
              <input type="number" id="timeEndMin" class="form-input time-input-min" min="0" max="59" placeholder="00" required>
              <input type="hidden" id="timeEnd" required>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="location">Location</label>
          <div class="location-input-wrapper">
            <input type="text" id="location" class="form-input" required autocomplete="off">
            <div id="locationDropdown" class="location-dropdown">
              <div class="location-dropdown-item" onclick="selectLocation('25 Prince\'s Island Park, SW, Calgary, AB T2P 0R1')">
                <div class="location-dropdown-item__text">25 Prince's Island Park, SW, Calgary, AB T2P 0R1</div>
              </div>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="notes">Notes</label>
          <textarea id="notes" class="form-input" rows="4" placeholder="Add notes..."></textarea>
        </div>

        <button type="submit" class="btn btn--primary btn--full">
          Save
        </button>
      </form>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
      <a href="itinerary.html" class="bottom-nav__item active">
        <img src="../images/calendar-39.svg" alt="Itinerary" class="bottom-nav__icon">
        <span class="bottom-nav__label">Itinerary</span>
      </a>
      <a href="homepage.html" class="bottom-nav__item">
        <img src="../images/home-42.svg" alt="Home" class="bottom-nav__icon">
        <span class="bottom-nav__label">Home</span>
      </a>
      <a href="emergency.html" class="bottom-nav__item">
        <img src="../images/icon-emergency-44.png" alt="Emergency" class="bottom-nav__icon">
        <span class="bottom-nav__label">Emergency</span>
      </a>
      <a href="settings.html" class="bottom-nav__item">
        <img src="../images/node-46.png" alt="Settings" class="bottom-nav__icon">
        <span class="bottom-nav__label">Settings</span>
      </a>
    </div>
  </div>

  <script>
    let lastSavedDate = null;   // remember which date we saved under

    // URL params
    const urlParams  = new URLSearchParams(window.location.search);
    let dateStr      = urlParams.get('date') || '2026-07-14';
    const eventIndex = urlParams.get('index') !== null ? parseInt(urlParams.get('index')) : -1;
    const isNewEvent = eventIndex === -1;

    // Load itineraryData from sessionStorage or create default
    let itineraryData = {};
    try {
      const saved = sessionStorage.getItem('itineraryData');
      if (saved) {
        itineraryData = JSON.parse(saved);
      }
    } catch (e) {
      console.error('Error loading itinerary data:', e);
    }

    if (!itineraryData['2026-07-14']) {
      // minimal default so page doesn't break the first time
      itineraryData = {
        '2026-07-14': {
          date: 'Tuesday - July 14, 2026',
          events: [
            {
              time: '10:00',
              title: 'Calgary Zoo',
              details: '10:00 - 13:00',
              address: '210 St. George\'s Drive NE, Calgary, AB T2E 7V6'
            },
            {
              time: '15:00',
              title: 'Peace Bridge',
              details: '15:00 - 16:00',
              address: '98 Memorial Dr NW, Calgary, AB T2N 5C1'
            }
          ]
        }
      };
      sessionStorage.setItem('itineraryData', JSON.stringify(itineraryData));
    }

    function getSelectedDate() {
      const input = document.getElementById('date');
      return (input && input.value) ? input.value : dateStr;
    }

    // ----- Custom 24-hour time input helpers -----
    function syncTimeFromHourMin(hourInputId, minInputId, hiddenTimeId) {
      const hourEl = document.getElementById(hourInputId);
      const minEl = document.getElementById(minInputId);
      const hiddenEl = document.getElementById(hiddenTimeId);
      
      if (hourEl && minEl && hiddenEl) {
        const hour = parseInt(hourEl.value, 10) || 0;
        const min = parseInt(minEl.value, 10) || 0;
        const hourClamped = Math.max(0, Math.min(23, hour));
        const minClamped = Math.max(0, Math.min(59, min));
        
        // Update hour/min inputs with clamped values (24-hour format)
        // Hour can be 0-23 (display without padding, but store with padding)
        hourEl.value = hourClamped;
        // Minutes always show with zero-padding (00-59)
        minEl.value = minClamped.toString().padStart(2, '0');
        
        // Update hidden time field in HH:MM format
        hiddenEl.value = String(hourClamped).padStart(2, '0') + ':' + String(minClamped).padStart(2, '0');
      }
    }

    function syncHourMinFromTime(timeString, hourInputId, minInputId, hiddenTimeId) {
      const hourEl = document.getElementById(hourInputId);
      const minEl = document.getElementById(minInputId);
      const hiddenEl = document.getElementById(hiddenTimeId);
      
      if (timeString && hourEl && minEl && hiddenEl) {
        const parts = timeString.split(':');
        if (parts.length === 2) {
          const hour = parseInt(parts[0], 10);
          const min = parseInt(parts[1], 10);
          
          if (!isNaN(hour) && !isNaN(min)) {
            const hourClamped = Math.max(0, Math.min(23, hour));
            const minClamped = Math.max(0, Math.min(59, min));
            
            hourEl.value = hourClamped;
            minEl.value = minClamped.toString().padStart(2, '0');
            hiddenEl.value = String(hourClamped).padStart(2, '0') + ':' + String(minClamped).padStart(2, '0');
          }
        }
      }
    }

    // ----- Helpers for conflicts -----
    function parseTime(timeStr) {
      const [hours, minutes] = timeStr.split(':').map(Number);
      return hours * 60 + minutes;
    }

    function checkTimeConflict(dateKey, startTime, endTime, excludeIndex = -1) {
      if (!itineraryData[dateKey] || !itineraryData[dateKey].events) return [];

      const events    = itineraryData[dateKey].events;
      const conflicts = [];

      const start = parseTime(startTime);
      const end   = parseTime(endTime);

      if (start >= end) {
        return [{ title: 'Invalid Time Range', time: 'End time must be after start time' }];
      }

      events.forEach((event, idx) => {
        if (idx === excludeIndex) return;

        const [eventStartStr, eventEndStr] = event.details.split(' - ');
        const eventStart = parseTime(eventStartStr);
        const eventEnd   = parseTime(eventEndStr);

        if (
          (start >= eventStart && start < eventEnd) ||
          (end > eventStart && end <= eventEnd) ||
          (start <= eventStart && end >= eventEnd)
        ) {
          conflicts.push({ title: event.title, time: event.details });
        }
      });

      return conflicts;
    }

    function showConflictWarning(conflicts) {
      const warningDiv   = document.getElementById('conflictWarning');
      const conflictList = document.getElementById('conflictList');

      if (conflicts.length > 0) {
        conflictList.innerHTML = conflicts
          .map(c => `<li class="conflict-warning__item">${c.title} (${c.time})</li>`)
          .join('');
        warningDiv.classList.add('show');
      } else {
        warningDiv.classList.remove('show');
      }
    }

    function checkConflicts() {
      // Sync hour/minute inputs to hidden time fields first
      syncTimeFromHourMin('timeStartHour', 'timeStartMin', 'timeStart');
      syncTimeFromHourMin('timeEndHour', 'timeEndMin', 'timeEnd');
      
      const startTime = document.getElementById('timeStart').value;
      const endTime   = document.getElementById('timeEnd').value;
      if (!startTime || !endTime) return true;

      const conflicts = checkTimeConflict(
        getSelectedDate(),
        startTime,
        endTime,
        isNewEvent ? -1 : eventIndex
      );
      showConflictWarning(conflicts);
      return conflicts.length === 0;
    }

    // ----- Load form data (pendingItineraryData > existing event > URL params) -----
    function loadFormData() {
      const pendingRaw = sessionStorage.getItem('pendingItineraryData');
      if (pendingRaw) {
        try {
          const data = JSON.parse(pendingRaw);
          if (data.title)     document.getElementById('title').value     = data.title;
          if (data.date)      document.getElementById('date').value      = data.date;
          if (data.startTime) syncHourMinFromTime(data.startTime, 'timeStartHour', 'timeStartMin', 'timeStart');
          if (data.endTime)   syncHourMinFromTime(data.endTime, 'timeEndHour', 'timeEndMin', 'timeEnd');
          if (data.location)  document.getElementById('location').value  = data.location;
        } catch (e) {
          console.warn('Bad pendingItineraryData', e);
        }

        const pickedDate = document.getElementById('date').value;
        if (pickedDate) dateStr = pickedDate;

        sessionStorage.removeItem('pendingItineraryData');
        return;
      }

      // Fallback: existing event or URL params
      document.getElementById('date').value = urlParams.get('date') || dateStr;

      const urlTitle     = urlParams.get('title');
      const urlStartTime = urlParams.get('startTime');
      const urlEndTime   = urlParams.get('endTime');
      const urlAddress   = urlParams.get('address');

      if (!isNewEvent && itineraryData[dateStr] && itineraryData[dateStr].events[eventIndex]) {
        const event = itineraryData[dateStr].events[eventIndex];
        document.getElementById('title').value = event.title;
        const [startTime, endTime] = event.details.split(' - ');
        syncHourMinFromTime(startTime, 'timeStartHour', 'timeStartMin', 'timeStart');
        syncHourMinFromTime(endTime, 'timeEndHour', 'timeEndMin', 'timeEnd');
        document.getElementById('location').value  = event.address;
        document.getElementById('notes').value     = event.note || '';
      } else if (isNewEvent && urlTitle) {
        document.getElementById('title').value     = urlTitle;
        syncHourMinFromTime(urlStartTime || '08:00', 'timeStartHour', 'timeStartMin', 'timeStart');
        syncHourMinFromTime(urlEndTime || '09:30', 'timeEndHour', 'timeEndMin', 'timeEnd');
        document.getElementById('location').value  =
          decodeURIComponent(urlAddress || '25 Prince\'s Island Park, SW, Calgary, AB T2P 0R1');
      }
    }

    // ----- Save event -----
    function saveEvent() {
      const title = document.getElementById('title').value;
      // Sync hour/minute inputs to hidden time fields
      syncTimeFromHourMin('timeStartHour', 'timeStartMin', 'timeStart');
      syncTimeFromHourMin('timeEndHour', 'timeEndMin', 'timeEnd');
      const startTime = document.getElementById('timeStart').value;
      const endTime   = document.getElementById('timeEnd').value;
      const location  = document.getElementById('location').value;
      const notes     = document.getElementById('notes').value.trim();

      const selectedDate = getSelectedDate();

      const conflicts = checkTimeConflict(
        selectedDate,
        startTime,
        endTime,
        isNewEvent ? -1 : eventIndex
      );

      // Show conflict warning and prevent saving if conflicts exist
      if (conflicts.length > 0) {
        showConflictWarning(conflicts);
        // Scroll to top to show the warning
        window.scrollTo({ top: 0, behavior: 'smooth' });
        return false; // Prevent saving
      } else {
        // Hide warning if no conflicts
        showConflictWarning([]);
      }

      const eventData = {
        time: startTime,
        title: title,
        details: `${startTime} - ${endTime}`,
        address: location,
        note: notes || ''
      };

      if (!itineraryData[selectedDate]) {
        const dateObj    = new Date(selectedDate + 'T00:00:00');
        const dayNames   = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

        itineraryData[selectedDate] = {
          date: `${dayNames[dateObj.getDay()]} - ${monthNames[dateObj.getMonth()]} ${dateObj.getDate()}, ${dateObj.getFullYear()}`,
          events: []
        };
      }

      if (isNewEvent) {
        itineraryData[selectedDate].events.push(eventData);
      } else {
        if (selectedDate === dateStr) {
          itineraryData[selectedDate].events[eventIndex] = eventData;
        } else {
          itineraryData[selectedDate].events.push(eventData);
          if (itineraryData[dateStr] && itineraryData[dateStr].events[eventIndex]) {
            itineraryData[dateStr].events.splice(eventIndex, 1);
          }
        }
      }

      itineraryData[selectedDate].events.sort((a, b) => parseTime(a.time) - parseTime(b.time));
      sessionStorage.setItem('itineraryData', JSON.stringify(itineraryData));

      lastSavedDate = selectedDate;

      const savedIndex = itineraryData[selectedDate].events.findIndex(e =>
        e.title   === eventData.title &&
        e.time    === eventData.time &&
        e.details === eventData.details &&
        e.address === eventData.address &&
        e.note    === eventData.note
      );

      return savedIndex !== -1 ? savedIndex : true;
    }

    // ----- Location dropdown helpers -----
    function shouldShowDropdown() {
      const title = document.getElementById('title').value.trim().toLowerCase();
      const locationInput = document.getElementById('location');
      return (title.includes('river cafe') || title.includes('river café')) &&
             document.activeElement === locationInput;
    }

    function showLocationDropdown() {
      if (shouldShowDropdown()) {
        document.getElementById('locationDropdown').classList.add('show');
      }
    }

    function hideLocationDropdown() {
      document.getElementById('locationDropdown').classList.remove('show');
    }

    function selectLocation(address) {
      document.getElementById('location').value = address;
      hideLocationDropdown();
    }

    function checkTitleAndShowDropdown() {
      if (shouldShowDropdown()) showLocationDropdown();
      else hideLocationDropdown();
    }

    // ----- Event wiring for custom 24-hour time inputs -----
    // Sync hour/minute inputs to hidden time fields on change (no conflict checking)
    function setupTimeInputSync() {
      // Start time inputs - only sync, don't check conflicts
      document.getElementById('timeStartHour').addEventListener('input', () => {
        syncTimeFromHourMin('timeStartHour', 'timeStartMin', 'timeStart');
      });
      document.getElementById('timeStartHour').addEventListener('change', () => {
        syncTimeFromHourMin('timeStartHour', 'timeStartMin', 'timeStart');
      });
      document.getElementById('timeStartMin').addEventListener('input', () => {
        syncTimeFromHourMin('timeStartHour', 'timeStartMin', 'timeStart');
      });
      document.getElementById('timeStartMin').addEventListener('change', () => {
        syncTimeFromHourMin('timeStartHour', 'timeStartMin', 'timeStart');
      });
      
      // End time inputs - only sync, don't check conflicts
      document.getElementById('timeEndHour').addEventListener('input', () => {
        syncTimeFromHourMin('timeEndHour', 'timeEndMin', 'timeEnd');
      });
      document.getElementById('timeEndHour').addEventListener('change', () => {
        syncTimeFromHourMin('timeEndHour', 'timeEndMin', 'timeEnd');
      });
      document.getElementById('timeEndMin').addEventListener('input', () => {
        syncTimeFromHourMin('timeEndHour', 'timeEndMin', 'timeEnd');
      });
      document.getElementById('timeEndMin').addEventListener('change', () => {
        syncTimeFromHourMin('timeEndHour', 'timeEndMin', 'timeEnd');
      });
    }
    
    setupTimeInputSync();

    document.getElementById('title').addEventListener('input', checkTitleAndShowDropdown);
    document.getElementById('location').addEventListener('focus', checkTitleAndShowDropdown);
    document.getElementById('location').addEventListener('input', checkTitleAndShowDropdown);

    document.getElementById('location').addEventListener('blur', () => {
      setTimeout(() => {
        if (!shouldShowDropdown()) hideLocationDropdown();
      }, 200);
    });

    document.addEventListener('click', (e) => {
      const locationWrapper = document.querySelector('.location-input-wrapper');
      if (!locationWrapper.contains(e.target)) {
        hideLocationDropdown();
      }
    });

    document.getElementById('editForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const result = saveEvent();
      if (result !== false) {
        if (!isNewEvent && urlParams.has('date') && urlParams.has('index')) {
          const dateParam = urlParams.get('date');
          const newIndex = (typeof result === 'number') ? result : parseInt(urlParams.get('index'));
          window.location.href = `itinerary-detail.html?date=${dateParam}&index=${newIndex}`;
        } else {
          if (lastSavedDate) {
            sessionStorage.setItem('lastViewedDate', lastSavedDate);
          }
          window.location.href = 'itinerary.html';
        }
      }
    });

    // Initial load
    loadFormData();
    
    // Sync hour/minute inputs after form data loads (no conflict checking on load)
    setTimeout(() => {
      syncTimeFromHourMin('timeStartHour', 'timeStartMin', 'timeStart');
      syncTimeFromHourMin('timeEndHour', 'timeEndMin', 'timeEnd');
      // Hide any conflict warnings on initial load
      showConflictWarning([]);
    }, 50);
  </script>
</body>
</html>
