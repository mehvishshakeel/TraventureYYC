<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Itinerary Detail - TraventureYYC</title>
  <link rel="stylesheet" href="../css/main.css">
</head>
<body>
  <div class="app-container">
    <!-- Status Bar -->
    <div class="status-bar">
      <div class="status-bar__left">
        <div class="status-bar__time">9:41</div>
      </div>
      <div class="status-bar__right">
        <div class="status-bar__signal">
          <img src="../images/mobile-signal-60.svg" alt="Signal">
        </div>
        <div class="status-bar__wifi">
          <img src="../images/wifi-59.svg" alt="WiFi">
        </div>
        <div class="status-bar__battery">
          <img src="../images/combined-shape-57.svg" alt="Battery">
          <img src="../images/rectangle-58.svg" alt="Battery">
        </div>
      </div>
    </div>

    <!-- Top Bar -->
    <div class="top-bar">
      <a href="#" id="backButton" style="color: var(--color-text-black);">‚Üê</a>
      <div class="top-bar__logo">
        Traventure<span class="top-bar__logo-accent">YYC</span>
      </div>
      <div class="top-bar__actions">
        <div></div>
      </div>
    </div>

    <!-- Content -->
    <div class="content">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
          <h1 id="eventTitle" style="font-size: 24px; font-weight: 700;">Loading...</h1>
          <div></div>
        </div>

        <div style="margin-bottom: var(--spacing-md);">
          <div style="font-size: 16px; color: var(--color-text-dark); margin-bottom: var(--spacing-sm);">
            <strong>Date:</strong> <span id="eventDate">Loading...</span>
          </div>
          <div style="font-size: 16px; color: var(--color-text-dark); margin-bottom: var(--spacing-sm);">
            <strong>Time:</strong> <span id="eventTime">Loading...</span>
          </div>
          <div style="font-size: 16px; color: var(--color-text-dark); margin-bottom: var(--spacing-sm);">
            <strong>Location:</strong> <span id="eventAddress">Loading...</span>
          </div>
          <div style="font-size: 16px; color: var(--color-text-dark);">
            <strong>Note:</strong> <span id="eventNote">Loading...</span>
          </div>
        </div>

        <img id="eventImage" src="" alt="" style="width: 100%; border-radius: var(--radius-sm); margin-top: var(--spacing-md);">
        
        <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-lg);">
          <button id="editActionBtn" class="btn btn--primary" style="flex: 1;">Edit</button>
          <button id="deleteActionBtn" class="btn btn--secondary" style="flex: 1;">Delete</button>
        </div>
      </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
      <a href="itinerary.html" class="bottom-nav__item">
      <a href="itinerary.html" class="bottom-nav__item">
        <img src="../images/calendar-39.svg" alt="Itinerary" class="bottom-nav__icon">
        <span class="bottom-nav__label">Itinerary</span>
      </a>
      <a href="homepage.html" class="bottom-nav__item active active">
        <img src="../images/home-42.svg" alt="Home" class="bottom-nav__icon">
        <span class="bottom-nav__label">Home</span>
      </a>
      <a href="emergency.html" class="bottom-nav__item">
        <img src="../images/icon-emergency-44.png" alt="Emergency" class="bottom-nav__icon">
        <span class="bottom-nav__label">Emergency</span>
      </a>
      <a href="settings.html" class="bottom-nav__item">
        <img src="../images/node-46.png" alt="Settings" class="bottom-nav__icon">
        <span class="bottom-nav__label">Settings</span>
      </a>
    </div>
  </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="delete-modal-overlay" style="display: none; opacity: 0;">
      <div class="delete-modal">
        <div class="delete-modal__icon">üóëÔ∏è</div>
        <h2 class="delete-modal__title">Delete Event</h2>
        <p class="delete-modal__message">Are you sure you want to delete <strong id="deleteModalEventName"></strong>?</p>
        <p class="delete-modal__submessage">This action cannot be undone, but you can use the undo notification to restore it.</p>
        <div class="delete-modal__actions">
          <button id="deleteModalCancel" class="btn btn--secondary">Cancel</button>
          <button id="deleteModalConfirm" class="btn btn--primary">Delete</button>
        </div>
      </div>
    </div>

  <script>
    // Default itinerary data (same as itinerary.html)
    const DEFAULT_ITINERARY_DATA = {
      '2026-07-11': {
        date: 'Saturday - July 11, 2026',
        events: [
          {
            time: '10:00',
            title: 'Calgary Zoo',
            details: '10:00 - 13:00',
            address: "210 St. George's Drive NE, Calgary, AB T2E 7V6"
          },
          {
            time: '14:00',
            title: 'Glenbow Museum',
            details: '14:00 - 16:00',
            address: '130 9 Ave SE, Calgary, AB T2G 0P3'
          }
        ]
      },
      '2026-07-12': {
        date: 'Sunday - July 12, 2026',
        events: [
          {
            time: '09:00',
            title: 'Heritage Park',
            details: '09:00 - 12:00',
            address: '1900 Heritage Dr SW, Calgary, AB T2V 2X3'
          },
          {
            time: '14:00',
            title: 'Olympic Plaza',
            details: '14:00 - 15:00',
            address: '228 8 Ave SE, Calgary, AB T2G 0K6'
          },
          {
            time: '17:00',
            title: 'Calgary Tower',
            details: '17:00 - 19:00',
            address: '101 9 Ave SW, Calgary, AB T2P 1J9'
          }
        ]
      },
      '2026-07-13': {
        date: 'Monday - July 13, 2026',
        events: [
          {
            time: '11:00',
            title: "Prince's Island Park",
            details: '11:00 - 13:00',
            address: '698 Eau Claire Ave SW, Calgary, AB T2P 5N4'
          },
          {
            time: '15:00',
            title: 'Bow River Pathway',
            details: '15:00 - 17:00',
            address: 'Along Bow River, Calgary, AB'
          }
        ]
      },
      '2026-07-14': {
        date: 'Tuesday - July 14, 2026',
        events: [
          {
            time: '10:00',
            title: 'Calgary Zoo',
            details: '10:00 - 13:00',
            address: "210 St. George's Drive NE, Calgary, AB T2E 7V6"
          },
          {
            time: '15:00',
            title: 'Peace Bridge',
            details: '15:00 - 16:00',
            address: '98 Memorial Dr NW, Calgary, AB T2N 5C1'
          },
          {
            time: '17:15',
            title: 'Ten Foot Henry',
            details: '17:15 - 19:00',
            address: '1209 1 St SW, Calgary, AB T2R 0V3'
          },
          {
            time: '19:00',
            title: 'Avesta Shawarma',
            details: '19:00 - 20:00',
            address: '698 Eau Claire Ave SW, Calgary, AB T2P 5N4'
          }
        ]
      },
      '2026-07-15': {
        date: 'Wednesday - July 15, 2026',
        events: [
          {
            time: '09:00',
            title: 'Studio Bell',
            details: '09:00 - 11:00',
            address: '850 4 St SE, Calgary, AB T2G 0L8'
          },
          {
            time: '12:00',
            title: 'Stephen Avenue Walk',
            details: '12:00 - 14:00',
            address: 'Stephen Ave, Calgary, AB'
          },
          {
            time: '16:00',
            title: 'Calgary Farmers Market',
            details: '16:00 - 18:00',
            address: '510 77 Ave SE, Calgary, AB T2H 1C3'
          }
        ]
      },
      '2026-07-16': {
        date: 'Thursday - July 16, 2026',
        events: [
          {
            time: '10:00',
            title: 'Fish Creek Provincial Park',
            details: '10:00 - 13:00',
            address: '15979 Bow Bottom Trail SE, Calgary, AB T2J 7A4'
          },
          {
            time: '15:00',
            title: 'Nose Hill Park',
            details: '15:00 - 17:00',
            address: '5620 14 St NW, Calgary, AB T2K 1J7'
          }
        ]
      },
      '2026-07-17': {
        date: 'Friday - July 17, 2026',
        events: [
          {
            time: '11:00',
            title: 'Calgary Stampede',
            details: '11:00 - 18:00',
            address: '1410 Olympic Way SE, Calgary, AB T2G 2W1'
          },
          {
            time: '19:00',
            title: 'Chuckwagon Races',
            details: '19:00 - 21:00',
            address: 'Stampede Park, Calgary, AB'
          }
        ]
      },
      '2026-07-18': {
        date: 'Saturday - July 18, 2026',
        events: [
          {
            time: '10:00',
            title: 'Calgary Stampede',
            details: '10:00 - 17:00',
            address: '1410 Olympic Way SE, Calgary, AB T2G 2W1'
          },
          {
            time: '18:00',
            title: 'Evening Concert',
            details: '18:00 - 21:00',
            address: 'Coca-Cola Stage, Stampede Park'
          }
        ]
      },
      '2026-07-19': {
        date: 'Sunday - July 19, 2026',
        events: []
      },
      '2026-07-20': {
        date: 'Monday - July 20, 2026',
        events: [
          {
            time: '14:00',
            title: 'Shopping at Chinook Centre',
            details: '14:00 - 17:00',
            address: '6455 Macleod Trail SW, Calgary, AB T2H 0K8'
          }
        ]
      }
    };

    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const dateStr = urlParams.get('date') || '2026-07-14';
    const eventIndex = urlParams.get('index') !== null ? parseInt(urlParams.get('index')) : 0;

    // Load itinerary data - merge defaults with sessionStorage
    let itineraryData = JSON.parse(JSON.stringify(DEFAULT_ITINERARY_DATA));
    try {
      const saved = sessionStorage.getItem('itineraryData');
      if (saved) {
        const storedData = JSON.parse(saved);
        // Merge: stored data takes priority, but defaults fill in missing days
        Object.keys(storedData).forEach(dateStr => {
          if (storedData[dateStr] && storedData[dateStr].events && storedData[dateStr].events.length > 0) {
            itineraryData[dateStr] = storedData[dateStr];
          }
        });
        // Ensure all default dates are present
        Object.keys(DEFAULT_ITINERARY_DATA).forEach(dateStr => {
          if (!itineraryData[dateStr] || !itineraryData[dateStr].events || itineraryData[dateStr].events.length === 0) {
            if (DEFAULT_ITINERARY_DATA[dateStr].events && DEFAULT_ITINERARY_DATA[dateStr].events.length > 0) {
              itineraryData[dateStr] = JSON.parse(JSON.stringify(DEFAULT_ITINERARY_DATA[dateStr]));
            }
          }
        });
      }
    } catch (e) {
      console.error('Error loading itinerary data:', e);
      itineraryData = JSON.parse(JSON.stringify(DEFAULT_ITINERARY_DATA));
    }

    // Load event data
    let currentEvent = null;
    function loadEventData() {
      // Ensure we have data for the requested date
      if (!itineraryData[dateStr]) {
        console.error(`No data found for date: ${dateStr}`);
        return;
      }
      
      if (!itineraryData[dateStr].events || !itineraryData[dateStr].events[eventIndex]) {
        console.error(`No event found at index ${eventIndex} for date: ${dateStr}`);
        return;
      }
      
      currentEvent = itineraryData[dateStr].events[eventIndex];
      const data = itineraryData[dateStr];
      
      // Update page elements
      const titleEl = document.getElementById('eventTitle');
      const dateEl = document.getElementById('eventDate');
      const timeEl = document.getElementById('eventTime');
      const addressEl = document.getElementById('eventAddress');
      const noteEl = document.getElementById('eventNote');
      const imageEl = document.getElementById('eventImage');
      
      if (titleEl) titleEl.textContent = currentEvent.title;
      if (dateEl) dateEl.textContent = data.date;
      if (timeEl) timeEl.textContent = currentEvent.details;
      if (addressEl) addressEl.textContent = currentEvent.address;
      
      // Display notes or "No notes" if empty
      const notesDisplay = currentEvent.note && currentEvent.note.trim() ? currentEvent.note : 'No notes';
      if (noteEl) noteEl.textContent = notesDisplay;

      // Set image based on title (case-insensitive matching)
      const normalizedTitle = currentEvent.title.trim().toLowerCase();
      let imageSrc = '../images/calgaryZOO.png'; // default
      
      if (normalizedTitle === 'calgary zoo') {
        imageSrc = '../images/calgaryZOO.png';
      } else if (normalizedTitle === 'peace bridge') {
        imageSrc = '../images/The_Peace_Bridge_in_Calgary_an_HDR_photo.png';
      } else if (normalizedTitle === 'ten foot henry') {
        imageSrc = '../images/tenfoothenry.png';
      } else if (normalizedTitle === 'avesta shawarma') {
        imageSrc = '../images/avesta.png';
      } else if ((normalizedTitle.includes('river') && normalizedTitle.includes('cafe')) || (normalizedTitle.includes('river') && normalizedTitle.includes('caf√©'))) {
        imageSrc = '../images/riverCafe.png';
      } else if (normalizedTitle === 'studio bell') {
        imageSrc = '../images/StudioBell.png';
      } else if (normalizedTitle === 'stephen avenue walk') {
        imageSrc = '../images/stephen-avenue.png';
      } else if (normalizedTitle === 'calgary farmers market') {
        imageSrc = '../images/calgary_farmers_market.png';
      } else if (normalizedTitle === 'fish creek provincial park') {
        imageSrc = '../images/fish_creek_provincial_park.png';
      } else if (normalizedTitle === 'bow river pathway') {
        imageSrc = '../images/Bow River Pathway.png';
      } else if (normalizedTitle === "prince's island park" || normalizedTitle === "princes island park") {
        imageSrc = '../images/princes-island-park.png';
      } else if (normalizedTitle === 'nose hill park') {
        imageSrc = '../images/Nose Hill Park.png';
      } else if (normalizedTitle === 'calgary stampede') {
        imageSrc = '../images/Calgary Stampede.png';
      } else if (normalizedTitle === 'chuckwagon races') {
        imageSrc = '../images/Chuckwagon Races.png';
      } else if (normalizedTitle === 'evening concert') {
        imageSrc = '../images/Evening Concert- Coca-Cola Stage.png';
      } else if (normalizedTitle === 'shopping at chinook centre') {
        imageSrc = '../images/Shopping at Chinook Centre.png';
      } else if (normalizedTitle === 'heritage park') {
        imageSrc = '../images/Heritage Park.png';
      } else if (normalizedTitle === 'olympic plaza') {
        imageSrc = '../images/Olympic Plaza.png';
      } else if (normalizedTitle === 'calgary tower') {
        imageSrc = '../images/Calgary Tower.png';
      } else if (normalizedTitle === 'glenbow museum') {
        imageSrc = '../images/Glenbow Museum.png';
      }
      if (imageEl) {
        imageEl.src = imageSrc;
        imageEl.alt = currentEvent.title;
      }
      
      // Update page title
      document.title = `${currentEvent.title} - TraventureYYC`;
    }

    // Store deleted event info for undo
    let deletedEventInfo = null;
    let undoTimeout = null;

    // Show undo notification
    function showUndoNotification() {
      const notification = document.getElementById('undoNotification');
      notification.style.display = 'block';
      setTimeout(() => {
        notification.style.opacity = '1';
        notification.style.transform = 'translateX(-50%) translateY(0)';
      }, 10);
    }

    // Hide undo notification
    function hideUndoNotification() {
      const notification = document.getElementById('undoNotification');
      notification.style.opacity = '0';
      notification.style.transform = 'translateX(-50%) translateY(-100%)';
      setTimeout(() => {
        notification.style.display = 'none';
        deletedEventInfo = null;
      }, 300);
    }

    // Show delete confirmation modal
    function showDeleteModal() {
      if (!currentEvent) return;
      
      const modal = document.getElementById('deleteModal');
      const modalContent = modal ? modal.querySelector('.delete-modal') : null;
      const eventNameEl = document.getElementById('deleteModalEventName');
      
      if (modal && modalContent && eventNameEl) {
        eventNameEl.textContent = currentEvent.title;
        modal.style.display = 'flex';
        
        // Trigger reflow to ensure display change is applied
        void modal.offsetWidth;
        
        // Add fade-in animation
        setTimeout(() => {
          modal.style.opacity = '1';
        }, 10);
      }
    }

    // Hide delete confirmation modal
    function hideDeleteModal() {
      const modal = document.getElementById('deleteModal');
      if (modal) {
        modal.style.opacity = '0';
        setTimeout(() => {
          modal.style.display = 'none';
        }, 200);
      }
    }

    // Actually perform the delete
    function confirmDelete() {
      if (!currentEvent) return;
      
      // Store event info for undo
      deletedEventInfo = {
        dateStr: dateStr,
        eventIndex: eventIndex,
        event: JSON.parse(JSON.stringify(currentEvent))
      };

      // Remove event from array
      itineraryData[dateStr].events.splice(eventIndex, 1);

      // Save to sessionStorage
      sessionStorage.setItem('itineraryData', JSON.stringify(itineraryData));

      // Save deleted event info to sessionStorage for undo (will be handled on itinerary page)
      sessionStorage.setItem('pendingUndo', JSON.stringify(deletedEventInfo));
      // Store the date so we can return to the correct date
      sessionStorage.setItem('lastViewedDate', dateStr);

      // Hide modal before redirecting
      hideDeleteModal();

      // Redirect back to itinerary page immediately
      setTimeout(() => {
        window.location.href = 'itinerary.html';
      }, 250);
    }

    // Delete event function - shows modal instead of confirm
    function deleteEvent() {
      if (!currentEvent) return;
      showDeleteModal();
    }

    // Undo delete function
    function undoDelete() {
      if (!deletedEventInfo) return;

      const { dateStr, eventIndex, event } = deletedEventInfo;

      // Ensure date entry exists
      if (!itineraryData[dateStr]) {
        const date = new Date(dateStr + 'T00:00:00');
        const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        itineraryData[dateStr] = {
          date: `${dayNames[date.getDay()]} - ${monthNames[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`,
          events: []
        };
      }

      // Insert event back at original position
      itineraryData[dateStr].events.splice(eventIndex, 0, event);

      // Re-sort events by time
      itineraryData[dateStr].events.sort((a, b) => {
        const timeA = parseTime(a.time);
        const timeB = parseTime(b.time);
        return timeA - timeB;
      });

      // Save to sessionStorage
      sessionStorage.setItem('itineraryData', JSON.stringify(itineraryData));

      // Hide notification
      hideUndoNotification();

      // Clear undo timeout
      if (undoTimeout) {
        clearTimeout(undoTimeout);
        undoTimeout = null;
      }

      // Store the date so we can return to the correct date
      sessionStorage.setItem('lastViewedDate', dateStr);

      // Redirect back to itinerary page to see restored event
      window.location.href = 'itinerary.html';
    }

    // Parse time string to minutes since midnight
    function parseTime(timeStr) {
      const [hours, minutes] = timeStr.split(':').map(Number);
      return hours * 60 + minutes;
    }

    // Edit event function
    function editEvent() {
      if (!currentEvent) return;
      const [startTime, endTime] = currentEvent.details.split(' - ');
      const note = currentEvent.note || '';
      window.location.href = `itinerary-edit.html?date=${dateStr}&index=${eventIndex}&title=${encodeURIComponent(currentEvent.title)}&startTime=${startTime}&endTime=${endTime}&address=${encodeURIComponent(currentEvent.address)}&note=${encodeURIComponent(note)}`;
    }

    // Function to navigate back to itinerary page with correct date
    function navigateToItinerary() {
      const urlParams = new URLSearchParams(window.location.search);
      const currentDate = urlParams.get('date') || '2026-07-14';
      sessionStorage.setItem('lastViewedDate', currentDate);
      window.location.href = 'itinerary.html';
    }

    // Setup navigation buttons
    function setupNavigation() {
      const backButton = document.getElementById('backButton');
      const bottomNavItinerary = document.getElementById('bottomNavItinerary');
      
      if (backButton) {
        backButton.addEventListener('click', (e) => {
          e.preventDefault();
          navigateToItinerary();
        });
      }
      
      if (bottomNavItinerary) {
        bottomNavItinerary.addEventListener('click', (e) => {
          e.preventDefault();
          navigateToItinerary();
        });
      }
    }

    // Setup on page load
    document.addEventListener('DOMContentLoaded', () => {
      setupNavigation();
      
      // Load event data
      loadEventData();
      
      // Set up event listeners
      const editBtn = document.getElementById('editActionBtn');
      const deleteBtn = document.getElementById('deleteActionBtn');
      
      if (editBtn) {
        editBtn.addEventListener('click', editEvent);
      }
      
      if (deleteBtn) {
        deleteBtn.addEventListener('click', deleteEvent);
      }

      // Modal buttons
      const deleteModalCancel = document.getElementById('deleteModalCancel');
      const deleteModalConfirm = document.getElementById('deleteModalConfirm');
      const deleteModal = document.getElementById('deleteModal');
      
      if (deleteModalCancel) {
        deleteModalCancel.addEventListener('click', hideDeleteModal);
      }
      
      if (deleteModalConfirm) {
        deleteModalConfirm.addEventListener('click', confirmDelete);
      }

      // Close modal when clicking outside
      if (deleteModal) {
        deleteModal.addEventListener('click', (e) => {
          if (e.target === deleteModal) {
            hideDeleteModal();
          }
        });
      }
    });
  </script>
</body>
</html>

